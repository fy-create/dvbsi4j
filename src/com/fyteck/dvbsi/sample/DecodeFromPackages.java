/*******************************************************************************
 * Copyright (c) 2021 FuYou Technology
 *
 *
 *   The content of this file includes portions of the FY Technology
 *   released in source code form as part of the SDK installer package.
 *
 *   Commercial License Usage
 *
 *   Licensees holding valid commercial licenses to the FY Technology
 *   may use this file in accordance with the end user license agreement provided 
 *   with the software or, alternatively, in accordance with the terms contained in a
 *   written agreement between you and FY Inc.
 *
 *
 *
 *   GNU General Public License Usage
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation; either version 2 of the License, or
 *   (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   You should have received a copy of the GNU General Public License
 *   along with this program; if not, write to the Free Software
 *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
 *******************************************************************************/
package com.fyteck.dvbsi.sample;

import com.fyteck.dvbsi.*;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import java.io.File;
import java.util.Arrays;

public class DecodeFromPackages extends DecodeEIT {
    public static void main(String[] args) {
        DecodeFromPackages decodeEITFromBuffer = new DecodeFromPackages();
        decodeEITFromBuffer.init();
        decodeEITFromBuffer.bitStream.setSectionNotify(decodeEITFromBuffer.sectionNotify);
        decodeEITFromBuffer.decodeBuffer();

        /* stop section manager thread */
        decodeEITFromBuffer.bitStream.getSectionManager().stop();
    }

    /**
     * Test EIT raw 188 packages
     */

    @Override
    protected void init() {
        /* initial DVB PID TID configure */
        String configFilePath = new File(".").getAbsolutePath();
        String configFile     = configFilePath + File.separator + "dvbConfig.json";
        GlobalConfig.dvbConfig = DVBConfig.checkConfig(new File(configFile));

        /* initial section and descriptor syntax */
        SyntaxConst.init();

        /* initial bit stream */
        bitStream = new BitStream();
    }

    private void decodeBuffer() {
        String[] rawEITPackages = new String[] {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //
                "[71,64,18,20,28,-56,9,47,83,53,48,56,55,57,50,52,118,11,-60,9,47,69,52,51,53,57,49,54,48,77,115,-99,-82,81,-3,107,-126,-64,-49,-128,-8,-128,10,35,58,-128,81,-96,25,-25,67,0,0,0,0,18,0,0,-73,84,2,80,0,77,-127,101,110,103,19,65,112,111,108,108,111,39,115,32,84,97,108,108,32,84,97,108,101,115,105,66,97,99,107,32,84,111,32,84,104,101,32,71,97,114,100,101,110,32,45,32,80,97,114,116,32,50,58,32,76,97,114,114,121,32,105,115,32,100,101,108,105,103,104,116,101,100,32,119,104,101,110,32,65,112,111,108,108,111,32,97,110,100,32,77,97,114,103,117,101,114,105,116,101,32,114,101,116,117,114,110,32,116,111,32,116,104,101,32,103,97,114,100,101,110,46,32,40,83]",                                        //
                "[71,0,18,21,49,32,69,112,50,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,50,55,56,53,48,54,118,11,-60,9,47,69,52,54,51,52,49,55,51,-96,26,-25,67,0,18,0,0,18,0,0,-22,84,2,80,0,77,-76,101,110,103,6,90,97,102,97,114,105,-87,74,117,109,112,105,110,103,32,116,111,32,67,111,110,99,108,117,115,105,111,110,115,58,32,83,111,109,101,98,111,100,121,39,115,32,98,101,101,110,32,112,108,97,121,105,110,103,32,112,114,97,110,107,115,32,111,110,32,116,104,101,32,115,108,101,101,112,105,110,103,32,90,97,102,97,114,105,97,110,115,32,101,97,99,104,32,110,105,103,104,116,44,32,108,101,97,100,105,110,103,32]",                                                     //
                "[71,0,18,22,90,111,111,109,98,97,32,116,111,32,108,97,117,110,99,104,32,97,110,32,105,110,118,101,115,116,105,103,97,116,105,111,110,32,119,105,116,104,32,115,117,114,112,114,105,115,105,110,103,32,114,101,115,117,108,116,115,46,32,40,83,49,32,69,112,49,48,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,57,54,56,55,50,52,118,11,-60,9,47,69,52,49,54,55,53,57,57,-96,27,-25,67,0,36,0,0,18,0,0,-42,84,2,80,0,77,-96,101,110,103,6,90,97,102,97,114,105,-107,87,104,97,116,39,115,32,105,110,32,97,32,78,105,99,107,58,32,90,111,111,109,98,97,32,97,110,100,32,81,117,105,110,99,121,32,105,110,118]",                                                           //
                "[71,0,18,23,101,110,116,32,110,105,99,107,110,97,109,101,115,32,102,111,114,32,101,97,99,104,32,111,116,104,101,114,32,98,117,116,32,113,117,105,99,107,108,121,32,108,101,97,114,110,32,116,104,97,116,32,105,116,39,115,32,110,111,116,32,97,32,103,111,111,100,32,103,97,109,101,32,119,104,101,110,32,102,101,101,108,105,110,103,115,32,99,97,110,32,103,101,116,32,104,117,114,116,46,32,40,83,50,32,69,112,49,48,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,48,56,53,54,50,48,118,11,-60,9,47,69,52,51,52,56,49,51,56,-96,28,-25,67,0,54,0,0,18,0,1,13,84,2,80,0,77,-41,101,110,103,10,75,111,100,121]",                                                       //
                "[71,0,18,24,32,75,97,112,111,119,-56,78,111,105,115,101,32,75,97,112,111,119,33,58,32,87,104,101,110,32,116,104,101,32,109,111,110,107,101,121,115,32,98,114,111,97,100,99,97,115,116,32,116,104,101,105,114,32,104,111,114,114,105,98,108,101,32,39,109,117,115,105,99,39,32,97,108,108,32,111,118,101,114,32,116,104,101,32,118,105,108,108,97,103,101,44,32,75,111,100,121,32,104,97,115,32,116,111,32,108,101,97,114,110,32,116,111,32,100,111,32,116,104,105,110,103,115,32,105,110,32,116,104,101,32,99,111,114,114,101,99,116,32,111,114,100,101,114,32,116,111,32,112,117,116,32,97,32,115,116,111,112,32,116,111,32,116,104,101,105,114,32,97,119,102,117,108,32,110,111,105,115,101,32,111,110,99,101]",   //
                "[71,0,18,25,32,97,110,100,32,102,111,114,32,97,108,108,46,32,40,83,49,32,69,112,49,48,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,57,55,51,52,56,54,118,11,-60,9,47,69,52,49,56,54,54,52,57,-96,29,-25,67,0,72,0,0,18,0,0,-111,84,2,80,0,77,91,101,110,103,12,84,114,117,108,108,105,32,84,97,108,101,115,74,83,117,114,112,114,105,115,105,110,103,32,80,101,97,32,83,111,117,112,58,32,83,117,110,32,100,101,99,105,100,101,115,32,116,104,97,116,32,115,104,101,32,100,111,101,115,32,110,111,116,32,108,105,107,101,32,108,101,103,117,109,101,115,46,32,40,83,49,32,69,112,52,55,41,80,6,-15,1]",                                                                 //
                "[71,0,18,26,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,48,52,57,53,50,53,118,11,-60,9,47,69,52,55,50,53,56,48,49,-96,30,-25,67,1,0,0,0,18,0,1,11,84,2,80,0,77,-43,101,110,103,8,76,105,108,121,98,117,100,115,-56,84,104,111,114,110,39,115,32,66,101,114,114,121,32,80,97,116,99,104,58,32,84,104,111,114,110,32,104,97,115,32,103,114,111,119,110,32,115,111,109,101,32,98,101,114,114,105,101,115,44,32,119,104,105,99,104,32,97,116,116,114,97,99,116,32,69,108,108,101,114,121,39,115,32,97,116,116,101,110,116,105,111,110,46,32,84,104,111,114,110,32,97,110,100,32,66,117,99,107,121,32,103,111,32,108,111,111,107,105]",                                                   //
                "[71,0,18,27,110,103,32,102,111,114,32,116,114,117,102,102,108,101,115,44,32,119,104,105,108,101,32,68,97,102,102,111,100,105,108,32,97,110,100,32,77,111,115,115,32,118,111,108,117,110,116,101,101,114,32,116,111,32,107,101,101,112,32,97,110,32,101,121,101,32,111,110,32,116,104,101,32,98,101,114,114,105,101,115,46,32,40,83,49,32,69,112,49,50,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,57,55,57,54,55,49,118,11,-60,9,47,69,52,50,49,50,48,50,48,-96,31,-25,67,1,18,0,0,18,0,0,-43,84,2,80,0,77,-97,101,110,103,17,69,108,108,97,44,32,79,115,99,97,114,32,38,32,72,111,111,-119,76,105,116,116,108]",                                                      //
                "[71,0,18,28,101,32,72,111,111,58,32,68,117,114,105,110,103,32,104,105,103,104,32,104,101,97,116,44,32,116,104,101,32,99,104,105,108,100,114,101,110,32,110,111,116,105,99,101,32,116,104,97,116,32,72,111,111,32,115,104,114,105,110,107,115,33,32,84,104,101,121,32,116,114,121,32,116,111,32,100,111,32,101,118,101,114,121,116,104,105,110,103,32,116,104,101,121,32,99,97,110,32,116,111,32,109,97,107,101,32,72,111,111,32,108,111,111,107,32,110,111,114,109,97,108,46,32,40,83,50,32,69,112,52,56,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,52,48,50,52,55,49,118,11,-60,9,47,69,52,56,50,48,49,57,53,-96,32,-25,67]",                                        //
                "[71,0,18,29,1,36,0,0,18,0,0,-45,84,2,80,0,77,-99,101,110,103,17,69,108,108,97,44,32,79,115,99,97,114,32,38,32,72,111,111,-121,72,97,97,58,32,79,115,99,97,114,32,109,97,107,101,115,32,69,108,108,97,32,98,101,108,105,101,118,101,32,116,104,97,116,32,97,32,115,101,99,111,110,100,32,99,108,111,117,100,32,110,97,109,101,100,32,72,97,97,32,104,97,115,32,106,111,105,110,101,100,32,116,104,101,109,46,32,72,111,111,32,104,97,115,32,116,111,32,112,108,97,121,32,97,32,100,111,117,98,108,101,32,114,111,108,101,44,32,119,104,105,99,104,32,105,115,110,39,116,32,101,97,115,121,33,32,40,83,50,32,69,112,52,57,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3]",                                                  //
                "[71,0,18,30,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,52,48,50,52,55,49,118,11,-60,9,47,69,52,56,50,48,49,57,54,-96,33,-25,67,1,54,0,0,18,0,0,-34,84,2,80,0,77,-88,101,110,103,27,66,97,98,97,114,32,65,110,100,32,84,104,101,32,65,100,118,101,110,116,117,114,101,115,46,46,46,-120,46,46,46,79,102,32,66,97,100,111,117,46,32,77,117,115,105,113,117,101,115,116,58,32,66,97,100,111,117,32,98,101,108,105,101,118,101,115,32,97,110,32,97,110,99,105,101,110,116,32,109,117,115,105,99,32,98,111,120,32,105,115,32,116,104,101,32,107,101,121,32,116,111,32,116,114,101,97,115,117,114,101,32,115,111,117,103,104,116,32,98,121,32,114,104,105,110,111,115]",                                             //
                "[71,0,18,31,44,32,101,108,101,112,104,97,110,116,115,32,97,110,100,32,99,114,111,99,111,100,105,108,101,115,46,32,40,83,50,32,69,112,49,51,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,57,49,48,53,54,49,118,11,-60,9,47,69,52,48,54,53,56,51,55,-96,34,-25,67,1,72,0,0,18,0,0,-66,84,2,80,0,77,-120,101,110,103,27,66,97,98,97,114,32,65,110,100,32,84,104,101,32,65,100,118,101,110,116,117,114,101,115,46,46,46,104,46,46,46,79,102,32,66,97,100,111,117,46,32,66,111,111,45,78,97,110,97,115,58,32,66,97,100,111,117,32,97,110,100,32,67,104,105,107,117,32,105,110,118,101,115,116,105,103,97]",                                                                  //
                "[71,0,18,16,116,101,32,114,101,112,111,114,116,115,32,111,102,32,97,32,109,111,110,115,116,101,114,32,112,108,97,103,117,105,110,103,32,77,111,110,107,101,121,118,105,108,108,101,46,32,40,83,50,32,69,112,49,52,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,57,49,48,53,54,49,118,11,-60,9,47,69,52,48,54,53,56,51,56,-96,35,-25,67,2,0,0,0,18,0,0,-24,84,2,80,0,77,-78,101,110,103,4,68,111,116,46,-87,69,97,115,121,32,83,113,117,101,101,122,121,58,32,68,111,116,32,116,97,107,101,115,32,105,116,32,117,112,111,110,32,104,101,114,115,101,108,102,32,116,111,32,104,101,108,112,32,72,97,108,32,119,105]",                                                     //
                "[71,0,18,17,116,104,32,104,105,115,32,108,101,109,111,110,97,100,101,32,115,116,97,110,100,44,32,97,110,100,32,119,105,110,100,115,32,117,112,32,116,97,107,105,110,103,32,111,118,101,114,32,116,104,101,32,119,104,111,108,101,32,116,104,105,110,103,32,105,110,32,104,101,114,32,97,116,116,101,109,112,116,32,116,111,32,98,117,105,108,100,32,97,32,108,101,109,111,110,97,100,101,32,101,109,112,105,114,101,46,32,40,83,49,32,69,112,57,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,56,52,52,53,49,56,118,11,-60,9,47,69,51,57,57,48,56,49,50,-96,36,-25,67,2,18,0,0,18,0,0,-57,84,2,80,0,77,-111,101,110,103]",                                               //
                "[71,0,18,18,10,82,97,110,103,101,114,32,82,111,98,-126,84,104,101,32,66,105,103,32,83,107,121,32,80,97,114,107,32,70,114,111,115,116,121,32,70,105,101,108,100,115,32,67,104,97,108,108,101,110,103,101,58,32,82,111,98,32,105,115,32,112,97,105,114,101,100,32,117,112,32,119,105,116,104,32,68,97,107,111,116,97,32,97,110,100,32,104,97,115,32,116,111,32,102,105,110,100,32,119,97,121,115,32,111,102,32,119,111,114,107,105,110,103,32,119,105,116,104,32,115,111,109,101,111,110,101,32,110,101,119,46,32,40,83,49,32,69,112,50,56,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,52,56,57,50,54,53,57,118,11,-60,9,47,69,52]",                                        //
                "[71,0,18,19,50,50,51,51,48,52,-96,37,-25,67,2,36,0,0,18,0,0,-70,84,2,80,0,77,-124,101,110,103,10,82,97,110,103,101,114,32,82,111,98,117,65,32,82,101,97,108,32,82,97,110,103,101,114,58,32,82,111,98,32,109,117,115,116,32,114,101,108,121,32,111,110,32,104,105,115,32,114,97,110,103,101,114,32,119,105,116,115,32,116,111,32,114,101,115,99,117,101,32,97,32,112,101,110,103,117,105,110,32,119,104,101,110,32,104,101,32,102,105,110,100,115,32,104,105,109,115,101,108,102,32,119,105,116,104,111,117,116,32,104,105,115,32,103,101,97,114,46,32,40,83,49,32,69,112,50,57,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83]",                                             //
                "[71,0,18,20,52,56,57,50,54,53,57,118,11,-60,9,47,69,52,50,50,51,51,48,54,-96,38,-25,67,2,54,0,0,18,0,1,6,84,2,80,0,77,-48,101,110,103,10,82,97,110,103,101,114,32,82,111,98,-63,84,104,101,32,83,110,111,119,32,77,111,110,107,101,121,32,75,105,110,103,32,111,102,32,66,105,103,32,83,107,121,32,80,97,114,107,58,32,87,104,101,110,32,82,111,98,32,97,110,100,32,83,116,111,109,112,101,114,32,103,111,32,116,111,32,111,98,115,101,114,118,101,32,115,110,111,119,32,109,111,110,107,101,121,115,44,32,83,116,111,109,112,101,114,32,103,101,116,115,32,97,32,108,105,116,116,108,101,32,116,111,111,32,99,108,111,115,101,46,32,84,104,101,32,115,110,111,119,32,109,111]",                                     //
                "[71,0,18,21,110,107,101,121,115,32,97,114,101,32,105,109,112,114,101,115,115,101,100,32,97,110,100,32,119,101,108,99,111,109,101,32,104,105,109,32,97,115,32,116,104,101,105,114,32,108,101,97,100,101,114,46,32,40,83,50,32,69,112,50,51,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,49,53,48,48,50,53,118,11,-60,9,47,69,52,52,56,48,54,52,49,-96,39,-25,67,2,72,0,0,18,0,0,-43,84,2,80,0,77,-97,101,110,103,10,77,111,110,99,104,104,105,99,104,105,-112,84,104,101,32,77,117,100,100,108,101,100,32,77,111,110,99,104,104,105,98,117,103,115,58,32,65,102,116,101,114,32,98,101,105,110,103,32,115,116,114,117]",                                                  //
                "[71,64,18,22,-101,99,107,32,98,121,32,111,110,101,32,111,102,32,65,105,107,111,114,39,115,32,115,112,101,108,108,115,44,32,116,104,101,32,77,111,110,99,104,104,105,98,117,103,115,32,112,111,117,110,99,101,32,111,110,32,116,104,101,32,70,97,114,97,110,100,111,108,105,115,32,108,101,97,118,101,115,32,97,110,100,32,100,101,118,111,117,114,32,116,104,101,109,33,32,40,83,49,32,69,112,49,54,41,80,6,-15,1,1,117,110,100,80,6,-14,3,3,101,110,103,95,4,0,0,35,58,118,11,-56,9,47,83,53,49,57,49,50,57,54,118,11,-60,9,47,69,52,53,48,55,57,56,53,-28,99,74,-100,81,-15,-69,-123,64,-43,40,-8,-128,10,35,58,40,81,-111,-69,-25,65,21,0,0,0,69,0,0,95,84,2]",                                                   //
        };

        Gson     gson           = new GsonBuilder().create();
        for (String packageJson : rawEITPackages) {
            byte[]   tspackageBytes = gson.fromJson(packageJson, byte[].class);

            TSPacket tsPackage      = new TSPacket(bitStream);
            /* rawData is PACKAGE_LEN package buffer */
            byte[]   rawData        = tsPackage.getRawData();

            /* clear package buffer */
            Arrays.fill(rawData, (byte) 0x0);

            System.arraycopy(tspackageBytes, 0, rawData, 0, BitStream.PACKAGE_LEN);
            tsPackage.parseHeader();

            /* try to push TS package to section manager,switch thread context */
            bitStream.getSectionManager().addTSPackage(tsPackage);
        }
    }

}
